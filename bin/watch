#!/usr/bin/env node

import fs from 'fs';
import path from 'path';
import { exec } from 'child_process';
import { fileURLToPath } from 'url';
import { watch } from 'chokidar';

const __dirname = path.dirname(fileURLToPath(import.meta.url));
const projectRoot = path.resolve(__dirname, '..');
const projectsDir = path.join(projectRoot, 'src', 'projects');
const modulesDir = path.join(projectRoot, 'src', 'modules');
const distDir = path.join(projectRoot, 'dist');

console.log('Starting SCAD watcher...');
console.log(`Watching projects: ${projectsDir}`);
console.log(`Watching modules:  ${modulesDir}`);

const isScad = (filePath) => filePath.endsWith('.scad');

function toStlPath(scadPath) {
  const relativePath = path.relative(projectsDir, scadPath);
  return path.join(distDir, relativePath.replace(/\.scad$/, '.stl'));
}

// --- Render ---

const debounceMap = new Map();

function renderFile(filePath) {
  const now = Date.now();
  if (now - (debounceMap.get(filePath) || 0) < 100) return;
  debounceMap.set(filePath, now);

  const stlFile = toStlPath(filePath);
  const stlDir = path.dirname(stlFile);

  if (!fs.existsSync(stlDir)) {
    fs.mkdirSync(stlDir, { recursive: true });
  }

  const rel = path.relative(projectRoot, stlFile);
  console.log(`Rendering: ${rel}`);

  exec(`openscad -o "${stlFile}" "${filePath}"`, (error, _stdout, stderr) => {
    if (error) {
      console.error(`Error: ${rel}`, stderr);
    } else {
      console.log(`Done: ${rel}`);
    }
  });
}

// --- Delete ---

function removeStl(scadPath) {
  const stlFile = toStlPath(scadPath);
  if (!fs.existsSync(stlFile)) return;

  fs.unlinkSync(stlFile);
  console.log(`Deleted: ${path.relative(projectRoot, stlFile)}`);

  // Remove empty parent directories up to dist/
  let dir = path.dirname(stlFile);
  while (dir !== distDir) {
    const entries = fs.readdirSync(dir);
    if (entries.length > 0) break;
    fs.rmdirSync(dir);
    console.log(`Removed empty dir: ${path.relative(projectRoot, dir)}`);
    dir = path.dirname(dir);
  }
}

// --- Rebuild all ---

let rebuildTimeout = null;

function rebuildAll() {
  if (rebuildTimeout) clearTimeout(rebuildTimeout);
  rebuildTimeout = setTimeout(() => {
    console.log('Module changed. Re-rendering all projects...');
    walkAndRender(projectsDir);
  }, 200);
}

function walkAndRender(dir) {
  if (!fs.existsSync(dir)) return;
  for (const entry of fs.readdirSync(dir)) {
    const fullPath = path.join(dir, entry);
    if (fs.statSync(fullPath).isDirectory()) {
      walkAndRender(fullPath);
    } else if (isScad(fullPath)) {
      renderFile(fullPath);
    }
  }
}

// --- Watcher setup ---

// usePolling for WSL compatibility (inotify doesn't work on /mnt/c)
const watcherOptions = {
  ignoreInitial: true,
  usePolling: true,
  interval: 500,
};

watch(projectsDir, watcherOptions)
  .on('add', (fp) => isScad(fp) && renderFile(fp))
  .on('change', (fp) => isScad(fp) && renderFile(fp))
  .on('unlink', (fp) => isScad(fp) && removeStl(fp));

watch(modulesDir, watcherOptions)
  .on('add', (fp) => isScad(fp) && rebuildAll())
  .on('change', (fp) => isScad(fp) && rebuildAll())
  .on('unlink', (fp) => isScad(fp) && rebuildAll());
