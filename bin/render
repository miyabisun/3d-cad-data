#!/bin/bash
set -e

# Determine the project root directory
DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
PROJECT_ROOT="$DIR/.."

cd "$PROJECT_ROOT"

# Clean dist/ before rebuild (.gitkeep preserved)
find dist -mindepth 1 ! -name '.gitkeep' -delete 2>/dev/null || true

echo "Rendering STL files..."

# Find all SCAD files in projects directory
find src/projects -name "*.scad" | while read -r scad_file; do
  # Remove 'src/projects/' prefix to get relative path
  relative_path="${scad_file#src/projects/}"

  # Construct output path in dist/
  stl_file="dist/${relative_path%.scad}.stl"

  # Create directory if it doesn't exist
  mkdir -p "$(dirname "$stl_file")"

  echo "Rendering $stl_file from $scad_file"
  openscad -o "$stl_file" "$scad_file"
done

echo "Render complete."
